# name: test/sql/local/irc/oauth2/test_oauth2_secret_with_refresh_token_only.test
# description: Test that refresh_token grant uses POST body credentials (Google-compatible)
# group: [oauth2]

# This test validates that when a secret is created with REFRESH_TOKEN parameter,
# the code correctly uses refresh_token grant (not client_credentials) and sends
# client credentials in POST body (not Basic Auth) for maximum compatibility with
# OAuth2 providers like Google that require this format.

require-env NESSIE_SERVER_AVAILABLE

require avro

require parquet

require iceberg

require httpfs

require aws

set ignore_error_messages

statement ok
CALL enable_logging('HTTP');

statement ok
set logging_level='debug';

statement ok
CREATE SECRET storage_secret (
    TYPE S3,
    KEY_ID 'minioadmin',
    SECRET 'minioadmin',
    ENDPOINT '127.0.0.1:9002',
    URL_STYLE 'path',
    USE_SSL 0
);

# Test 1: Verify that providing REFRESH_TOKEN parameter triggers refresh_token grant
# Keycloak accepts both Basic Auth and POST body for refresh_token grant
statement ok
CALL truncate_duckdb_logs();

# Note: Keycloak will reject an invalid refresh_token
# The error proves we attempted refresh_token grant (not client_credentials)
statement error
CREATE SECRET test_refresh_grant_attempt (
    TYPE ICEBERG,
    CLIENT_ID 'client1',
    CLIENT_SECRET 's3cr3t',
    REFRESH_TOKEN 'invalid_refresh_token_for_testing',
    OAUTH2_SERVER_URI 'http://127.0.0.1:8080/realms/iceberg/protocol/openid-connect/token',
    EXTRA_HTTP_HEADERS MAP {}
);
----
invalid_grant

# Verify a POST request was made (attempting refresh_token grant)
query I
SELECT COUNT(*) >= 1 AS attempted_refresh_grant FROM duckdb_logs_parsed('HTTP')
WHERE request.type = 'POST' 
  AND request.url LIKE '%openid-connect/token%';
----
true

# Test 2: Verify normal client_credentials still works
statement ok
CALL truncate_duckdb_logs();

statement ok
CREATE SECRET normal_oauth (
    TYPE ICEBERG,
    CLIENT_ID 'client1',
    CLIENT_SECRET 's3cr3t',
    OAUTH2_SCOPE 'catalog sign',
    OAUTH2_SERVER_URI 'http://127.0.0.1:8080/realms/iceberg/protocol/openid-connect/token'
);

# Verify client_credentials grant was used
query I
SELECT COUNT(*) >= 1 AS used_client_creds FROM duckdb_logs_parsed('HTTP')
WHERE request.type = 'POST' 
  AND request.url LIKE '%openid-connect/token%';
----
true

statement ok
DROP SECRET normal_oauth;

statement ok
DROP SECRET storage_secret;

