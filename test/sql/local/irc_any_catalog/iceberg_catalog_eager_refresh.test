# name: test/sql/local/irc_any_catalog/iceberg_catalog_eager_refresh.test
# description: test integration with iceberg catalog read
# group: [irc_any_catalog]

require-env ICEBERG_SERVER_AVAILABLE

require-env SECRETS_CREATED_AND_CATALOG_ATTACHED

require avro

require parquet

require iceberg

require httpfs

# Do not ignore 'HTTP' error messages!
set ignore_error_messages

statement ok
CALL enable_logging('HTTP');

statement ok
set logging_level='debug'

statement ok
CALL truncate_duckdb_logs();

statement ok
begin transaction

# These happen in the same transaction, so we hit only hit the catalog once

statement ok
select * from my_datalake.default.table_unpartitioned order by all;

statement ok
select * from my_datalake.default.table_more_deletes order by all;

query II
SELECT request.url, response.reason FROM duckdb_logs_parsed('HTTP') WHERE request.type='GET' AND (request.url).starts_with('http://127.0.0.1:8181/v1/') order by timestamp
----
http://127.0.0.1:8181/v1/namespaces/default/tables/table_unpartitioned	OK
http://127.0.0.1:8181/v1/namespaces/default/tables/table_more_deletes	OK

statement ok
CALL truncate_duckdb_logs();

statement ok
select * from my_datalake.default.table_more_deletes order by all;

# No extra logs are created because all the metadata was already cached
query II
SELECT request.url, response.reason FROM duckdb_logs_parsed('HTTP') WHERE request.type='GET' AND (request.url).starts_with('http://127.0.0.1:8181/v1/') order by timestamp
----

statement ok
commit

# Now query the same table twice outside of a transaction

statement ok
select * from my_datalake.default.table_more_deletes order by all;

statement ok
select * from my_datalake.default.table_more_deletes order by all;

# The catalog is hit every time, to get a potential refresh of the state of the schemas/tables in it

query II
SELECT request.url, response.reason FROM duckdb_logs_parsed('HTTP') WHERE request.type='GET' AND (request.url).starts_with('http://127.0.0.1:8181/v1/') order by timestamp
----
http://127.0.0.1:8181/v1/namespaces/default/tables/table_more_deletes	OK
http://127.0.0.1:8181/v1/namespaces/default/tables/table_more_deletes	OK
