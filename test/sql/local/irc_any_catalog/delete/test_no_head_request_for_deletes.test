# name: test/sql/local/irc_any_catalog/delete/test_no_head_request_for_deletes.test
# description: Test ducklake deleting multiple batches
# group: [delete]

require-env ICEBERG_SERVER_AVAILABLE

require-env SECRETS_CREATED_AND_CATALOG_ATTACHED

require avro

require parquet

require iceberg

require httpfs

# Do not ignore 'HTTP' error messages!
set ignore_error_messages

statement ok
set logging_level='debug'

statement ok
create schema if not exists my_datalake.default;

statement ok
DROP TABLE IF EXISTS my_datalake.default.test;

statement ok
CREATE TABLE my_datalake.default.test AS SELECT i id FROM range(1000) t(i);

statement ok
delete from my_datalake.default.test where id in (100, 200, 300);

# verify there is 1 delete file
query I
select count(*) from iceberg_metadata(my_datalake.default.test) where manifest_content = 'DELETE';
----
1

statement ok
begin;

statement ok
CALL enable_logging('HTTP');

# populate the cache
statement ok
select * from my_datalake.default.test;

# 1 get call for delete information
query I
select count(*) from duckdb_logs_parsed('HTTP') where request.type in ('GET') and request.url like '%-deletes.parquet%';
----
1

# 0 head calls for delete information
query I
select count(*) from duckdb_logs_parsed('HTTP') where request.type in ('HEAD') and request.url like '%-deletes.parquet%';
----
0

statement ok
call truncate_duckdb_logs();

statement ok
select * from my_datalake.default.test;

# no extra calls at all on second request
query I
select count(*) from duckdb_logs_parsed('HTTP');
----
0

statement ok
abort;

statement ok
drop table my_datalake.default.test;


