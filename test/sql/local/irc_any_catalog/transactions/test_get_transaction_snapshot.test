# name: test/sql/local/irc_any_catalog/transactions/test_get_transaction_snapshot.test
# group: [transactions]

require-env ICEBERG_SERVER_AVAILABLE

require-env SECRETS_CREATED_AND_CATALOG_ATTACHED

require avro

require parquet

require iceberg

require httpfs

# Do not ignore 'HTTP' error messages!
set ignore_error_messages

statement ok
set enable_logging=true

statement ok
set logging_level='debug'

# Perform an INSERT and COMMIT it so table has a snapshot id other transactions can find
statement ok
drop table if exists my_datalake.default.get_transaction_snapshot;

statement ok
create table my_datalake.default.get_transaction_snapshot (a int, b int);

# make sure the table has a snapshot id to start
statement ok
insert into my_datalake.default.get_transaction_snapshot select 0, 0;

statement ok con1
begin

statement ok con1
insert into my_datalake.default.get_transaction_snapshot select 1, 1;

# we will not show committed local snapshots for (iceberg_snapshots)
query I con1
select count(*) from iceberg_snapshots(my_datalake.default.get_transaction_snapshot);
----
1

statement ok con1
commit;

query I
select count(*) from iceberg_snapshots(my_datalake.default.get_transaction_snapshot);
----
2

