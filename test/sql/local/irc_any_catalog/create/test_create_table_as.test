# name: test/sql/local/irc_any_catalog/create/test_create_table_as.test
# description: test create table as
# group: [create]

require-env ICEBERG_SERVER_AVAILABLE

require-env SECRETS_CREATED_AND_CATALOG_ATTACHED

require avro

require parquet

require iceberg

require httpfs

require core_functions

# Do not ignore 'HTTP' error messages!
set ignore_error_messages

statement ok
CALL enable_logging('HTTP');

statement ok
set logging_level='debug'


statement ok
use my_datalake.default;

statement ok
DROP TABLE if exists all_types_table_primitives_2;

statement ok
DROP TABLE if exists nested_types_2;

statement ok
DROP TABLE if exists fixed_array_table_as_list;

# create primitive type table from test all types
statement ok
create table all_types_table_primitives_2 as select
bool,
int,
bigint,
date,
time,
timestamp,
timestamp_tz,
float,
double,
dec_4_1,
dec_9_4,
dec_18_6,
dec38_10,
uuid,
varchar,
blob from test_all_types();

query T nosort res_1
select * from all_types_table_primitives_2;
----

query T nosort res_1
select
bool,
int,
bigint,
date,
time,
timestamp,
timestamp_tz,
float,
double,
dec_4_1,
dec_9_4,
dec_18_6,
dec38_10,
uuid,
varchar,
blob from test_all_types();
----

statement ok
drop table if exists nested_types_2;

# create nested types table from test all types
statement ok
create table nested_types_2 as select
int_array,
double_array,
array_filter(date_array, lambda x: (x != 'infinity' and x != '-infinity')),
array_filter(timestamp_array, lambda x: (x != 'infinity' and x != '-infinity')),
array_filter(timestamptz_array, lambda x: (x != 'infinity' and x != '-infinity')),
varchar_array,
nested_int_array,
struct,
struct_of_arrays,
array_of_structs,
map from test_all_types();

query T nosort res2
select * from nested_types_2;
----

query T nosort res2
select int_array,
double_array,
array_filter(date_array, lambda x: (x != 'infinity' and x != '-infinity')),
array_filter(timestamp_array, lambda x: (x != 'infinity' and x != '-infinity')),
array_filter(timestamptz_array, lambda x: (x != 'infinity' and x != '-infinity')),
varchar_array,
nested_int_array,
struct,
struct_of_arrays,
array_of_structs,
map from test_all_types();
----

# fixed length array types will be supported later
# They can be supported if cast to list
statement error
create table fixed_array_table as select
fixed_int_array,
fixed_varchar_array,
fixed_nested_int_array,
fixed_nested_varchar_array,
fixed_struct_array,
struct_of_fixed_array,
list_of_fixed_int_array from test_all_types();
----
<REGEX>:.*Please cast to LIST.*

statement ok
drop table if exists fixed_array_table_as_list;

# casting to list works
statement ok
create table fixed_array_table_as_list as select
fixed_int_array::INTEGER[] fixed_int_array,
fixed_varchar_array::VARCHAR[] fixed_varchar_array,
fixed_nested_int_array::INTEGER[][] fixed_nested_int_array,
fixed_nested_varchar_array::VARCHAR[] fixed_nested_varchar_array,
fixed_struct_array::STRUCT(a VARCHAR, b VARCHAR)[] fixed_struct_array,
struct_of_fixed_array::STRUCT(a VARCHAR, b VARCHAR[]) struct_of_fixed_array,
list_of_fixed_int_array::INTEGER[][] list_of_fixed_int_array,
fixed_array_of_int_list::INTEGER[][] fixed_array_of_int_list from test_all_types();

query T nosort res3
select
fixed_int_array::INTEGER[] fixed_int_array,
fixed_varchar_array::VARCHAR[] fixed_varchar_array,
fixed_nested_int_array::INTEGER[][] fixed_nested_int_array,
fixed_nested_varchar_array::VARCHAR[] fixed_nested_varchar_array,
fixed_struct_array::STRUCT(a VARCHAR, b VARCHAR)[] fixed_struct_array,
struct_of_fixed_array::STRUCT(a VARCHAR, b VARCHAR[]) struct_of_fixed_array,
list_of_fixed_int_array::INTEGER[][] list_of_fixed_int_array,
fixed_array_of_int_list::INTEGER[][] from test_all_types();
----

query T nosort res3
select * from fixed_array_table_as_list;
----

statement error
create table bit_table as select bit from test_all_types();
----
<REGEX>:.*Invalid Input.*Column type BIT is not a valid Iceberg Type.*

