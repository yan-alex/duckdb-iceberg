# name: test/sql/cloud/snowflake/test_create_table_with_properties.test
# description: test integration with iceberg catalog read
# group: [snowflake]

require-env ICEBERG_SNOWFLAKE_REMOTE_AVAILABLE

require-env SNOWFLAKE_KEY_ID_GCS

require-env SNOWFLAKE_SECRET_KEY_GCS

require-env SNOWFLAKE_CATALOG_URI_GCS

require avro

require parquet

require iceberg

require httpfs


# Do not ignore 'HTTP' error messages!
set ignore_error_messages


statement ok
create secret polaris_secret (
	TYPE ICEBERG,
	CLIENT_ID '${SNOWFLAKE_KEY_ID_GCS}',
	CLIENT_SECRET '${SNOWFLAKE_SECRET_KEY_GCS}',
	ENDPOINT '${SNOWFLAKE_CATALOG_URI_GCS}'
);

statement ok
attach 'GCS_catalog' as my_datalake (
	type ICEBERG,
	ENDPOINT '${SNOWFLAKE_CATALOG_URI_GCS}'
);

statement ok
create schema if not exists my_datalake.test_create_schema;

statement ok
drop table if exists my_datalake.test_create_schema.test_create_table_with_properties;

statement ok
use my_datalake.test_create_schema;

statement ok
create table test_create_table_with_properties (a int)
WITH (
    'format-version'='2',
    'property1'='value1',
    'property2'='value2'
);

query II
select * from iceberg_table_properties(my_datalake.test_create_schema.test_create_table_with_properties) where key like '%property%' order by key;
----
property1	value1
property2	value2

statement error
create table invalid_table_format_version (a int) 
WITH (
    'format-version'='3',
    'property1'='value1', 
    'property2'='value2'
);
----
<REGEX>:.*DuckDB-Iceberg only supports creating version 2 Iceberg tables.*

